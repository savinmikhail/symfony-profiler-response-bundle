{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{% block toolbar %}
    {% set icon %}
        {{ include('@ResponseProfiler/Icon/response-body.svg') }}
        <span class="sf-toolbar-value">{{ collector.json ? 'JSON' : (collector.mime ?: 'n/a') }}</span>
        {% if collector.captured %}
            <span class="sf-toolbar-label">{{ (collector.size / 1024)|number_format(1) }} KB</span>
        {% endif %}
    {% endset %}

    {% set text %}
        <div class="sf-toolbar-info-piece">
            <b>Content-Type</b>
            <span>{{ collector.contentType ?: 'unknown' }}</span>
        </div>
        <div class="sf-toolbar-info-piece">
            <b>Size</b>
            <span>{{ collector.size }} B{% if collector.truncated %} (truncated){% endif %}</span>
        </div>
    {% endset %}

    {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', { link: collector.captured ? profiler_url : false }) }}
{% endblock %}

{% block menu %}
    <span class="label {{ collector.captured ? '' : 'disabled' }}">
        <span class="icon">{{ include('@ResponseProfiler/Icon/response-body.svg') }}</span>
        <strong>Response Body</strong>
    </span>
{% endblock %}

{% block panel %}
    <style>
        .rfp-body-actions { display:flex; gap:.5rem; align-items:center; margin: .5rem 0 1rem; }
        .rfp-badge { background: var(--highlight-color, #2ea44f); color:#fff; border-radius: 3px; padding: 2px 6px; font-size: 12px; }
        .rfp-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .rfp-pre { white-space: pre-wrap; word-break: break-word; }
        .rfp-code { border: 1px solid var(--border-color, #3c3f44); border-radius: 6px; padding: 10px 12px; background: var(--code-bg, rgba(0,0,0,.2)); }
        .btn.selected { background: var(--highlight-color, #2ea44f); color: #fff; }
    </style>

    <h2>Response Body</h2>

    {% if not collector.captured %}
        <div class="empty">
            <p>No capturable response body ({{ collector.reason ?: 'unknown reason' }}).</p>
            {% if collector.contentType %}
                <p>Content-Type: <code>{{ collector.contentType }}</code></p>
            {% endif %}
        </div>
    {% else %}
        <div class="metrics">
            <div class="metric">
                <span class="value">{{ collector.mime ?: 'n/a' }}</span>
                <span class="label">MIME</span>
            </div>
            <div class="metric">
                <span class="value">{{ collector.size }} <span class="unit">B</span></span>
                <span class="label">Original size</span>
            </div>
            <div class="metric">
                <span class="value">{{ collector.displaySize }} <span class="unit">B</span></span>
                <span class="label">Displayed</span>
            </div>
            <div class="metric">
                <span class="value">{{ collector.maxLength }} <span class="unit">B</span></span>
                <span class="label">Max length</span>
            </div>
        </div>

        <div class="rfp-body-actions">
            {% if collector.json %}<span class="rfp-badge">JSON</span>{% endif %}
            {% if collector.hasPretty() %}
                <button id="rfp-btn-pretty" class="btn btn-sm selected" type="button">Pretty</button>
                <button id="rfp-btn-raw" class="btn btn-sm" type="button">Raw</button>
            {% else %}
                <span class="label">Raw</span>
            {% endif %}
            <button id="rfp-copy" class="btn btn-sm" type="button">Copy</button>
            <button id="rfp-download" class="btn btn-sm" type="button">Download</button>
            {% if collector.truncated %}
                <span class="label">Truncated at {{ collector.maxLength }} bytes</span>
            {% endif %}
        </div>

        <div class="rfp-code">
            {% if collector.hasPretty() %}
                <pre id="rfp-body-pretty" class="sf-dump sf-reset rfp-mono rfp-pre">{{ collector.pretty }}</pre>
            {% endif %}
            <pre id="rfp-body-raw" class="sf-dump sf-reset rfp-mono rfp-pre" style="display: {{ collector.hasPretty() ? 'none' : 'block' }};">{{ collector.hasPretty() ? collector.raw : collector.content }}</pre>
        </div>

        <script>
            (function () {
                const hasPretty = {{ collector.hasPretty() ? 'true' : 'false' }};
                const prettyBtn = document.getElementById('rfp-btn-pretty');
                const rawBtn = document.getElementById('rfp-btn-raw');
                const copyBtn = document.getElementById('rfp-copy');
                const dlBtn = document.getElementById('rfp-download');
                const pretty = document.getElementById('rfp-body-pretty');
                const raw = document.getElementById('rfp-body-raw');

                function activePre() { return hasPretty && pretty && pretty.style.display !== 'none' ? pretty : raw; }

                function show(which) {
                    if (!hasPretty) return;
                    if (which === 'pretty') {
                        if (pretty) pretty.style.display = 'block';
                        if (raw) raw.style.display = 'none';
                        if (prettyBtn) prettyBtn.classList.add('selected');
                        if (rawBtn) rawBtn.classList.remove('selected');
                    } else {
                        if (pretty) pretty.style.display = 'none';
                        if (raw) raw.style.display = 'block';
                        if (prettyBtn) prettyBtn.classList.remove('selected');
                        if (rawBtn) rawBtn.classList.add('selected');
                    }
                }

                if (prettyBtn) prettyBtn.addEventListener('click', function () { show('pretty'); });
                if (rawBtn) rawBtn.addEventListener('click', function () { show('raw'); });

                copyBtn && copyBtn.addEventListener('click', function () {
                    const el = activePre();
                    if (el) navigator.clipboard.writeText(el.innerText);
                });

                dlBtn && dlBtn.addEventListener('click', function () {
                    const el = activePre();
                    if (!el) return;
                    const text = el.innerText;
                    const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = hasPretty && pretty && pretty.style.display !== 'none' ? 'response.json' : 'response.txt';
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
                });
            })();
        </script>
    {% endif %}
{% endblock %}
